# Smart Ledger 单元测试实施方案

## 概述

本文档是 `单元测试方案.md` 的配套实施指南，按 Phase 划分具体任务，每个 Phase 包含明确的交付物和验收标准。

---

## Phase 1: 基础设施搭建

### 目标
- 安装并配置 Vitest 测试框架
- 创建测试目录结构
- 配置 Mock 基础设施
- 创建测试数据工厂

### 任务清单

| 序号 | 任务 | 文件 | 说明 |
|-----|------|------|------|
| 1.1 | 安装依赖 | `package.json` | 添加 Vitest 及相关依赖 |
| 1.2 | Vitest 配置 | `vitest.config.ts` | 配置测试环境、别名、覆盖率 |
| 1.3 | Setup 文件 | `vitest.setup.ts` | Mock Next.js、localStorage 等 |
| 1.4 | Prisma Mock | `__tests__/__mocks__/prisma.ts` | Prisma Client Mock |
| 1.5 | 测试工厂 | `__tests__/__factories__/` | 创建测试数据生成工厂 |
| 1.6 | npm scripts | `package.json` | 添加测试脚本 |

### 交付物
```
smart-ledger/
├── vitest.config.ts
├── vitest.setup.ts
├── __tests__/
│   ├── __mocks__/
│   │   └── prisma.ts
│   └── __factories__/
│       ├── transaction.ts
│       ├── budget.ts
│       └── category.ts
└── package.json (updated)
```

### 验收标准
- [ ] `npm run test` 能正常运行
- [ ] `npm run test:coverage` 能生成覆盖率报告
- [ ] Mock 文件正确加载

---

## Phase 2: P0 模块测试实现

### 目标
- 完成所有高优先级（P0）模块的单元测试
- 达成目标覆盖率 90-95%

### 2.1 工具函数测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 2.1.1 | `lib/utils/date.ts` | `date.test.ts` | 25-30 | 95% |
| 2.1.2 | `lib/utils/format.ts` | `format.test.ts` | 8-10 | 95% |
| 2.1.3 | `lib/utils/validation.ts` | `validation.test.ts` | 15-20 | 95% |
| 2.1.4 | `lib/utils/helpers.ts` | `helpers.test.ts` | 10-15 | 90% |
| 2.1.5 | `lib/utils/storage.ts` | `storage.test.ts` | 12-15 | 90% |

#### date.ts 测试用例明细

```
describe('monthRange')
  ✓ 返回当月日期范围
  ✓ 返回上月日期范围
  ✓ 处理年份边界（1月→上年12月）
  ✓ 默认使用当前日期

describe('parseMonthStr')
  ✓ 解析有效的 YYYY-MM 格式
  ✓ 无效格式返回 null
  ✓ 月份超范围返回 null
  ✓ 空字符串返回 null

describe('formatMonth')
  ✓ 格式化为 YYYY-MM
  ✓ 单位数月份补零

describe('shiftMonth')
  ✓ 向前偏移 N 个月
  ✓ 向后偏移 N 个月
  ✓ 跨年处理

describe('todayISO')
  ✓ 返回 YYYY-MM-DD 格式
  ✓ 使用本地时区

describe('getQuickRange')
  ✓ today 返回今日范围
  ✓ yesterday 返回昨日范围
  ✓ last7 返回近7日范围
  ✓ month 返回当月范围
```

### 2.2 缓存层测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 2.2.1 | `MemoryCache` | `MemoryCache.test.ts` | 18-22 | 95% |
| 2.2.2 | `CacheDecorator` | `CacheDecorator.test.ts` | 15-18 | 90% |
| 2.2.3 | `LocalStorageCache` | `LocalStorageCache.test.ts` | 12-15 | 85% |

#### MemoryCache 测试用例明细

```
describe('get/set')
  ✓ 存储并获取值
  ✓ 不存在的 key 返回 null
  ✓ 支持存储 null 值（allowNull）

describe('TTL 过期')
  ✓ TTL 内能获取值
  ✓ 过期后返回 null
  ✓ 过期后自动清理

describe('标签系统')
  ✓ 添加标签关联
  ✓ 按标签批量失效
  ✓ 多标签支持

describe('前缀失效')
  ✓ 按前缀批量删除

describe('统计信息')
  ✓ 命中计数
  ✓ 未命中计数
  ✓ 命中率计算
```

### 2.3 错误处理测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 2.3.1 | `AppError` | `AppError.test.ts` | 20-25 | 95% |
| 2.3.2 | `ErrorCode` | `ErrorCode.test.ts` | 8-10 | 100% |
| 2.3.3 | `errorHandler` | `errorHandler.test.ts` | 10-12 | 85% |

### 2.4 智能模式测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 2.4.1 | `smartPatterns` | `smartPatterns.test.ts` | 18-22 | 95% |
| 2.4.2 | `smartSuggestions` | `smartSuggestions.test.ts` | 12-15 | 85% |

### 交付物
```
__tests__/unit/
├── utils/
│   ├── date.test.ts
│   ├── format.test.ts
│   ├── validation.test.ts
│   ├── helpers.test.ts
│   └── storage.test.ts
├── cache/
│   ├── MemoryCache.test.ts
│   ├── CacheDecorator.test.ts
│   └── LocalStorageCache.test.ts
├── errors/
│   ├── AppError.test.ts
│   ├── ErrorCode.test.ts
│   └── errorHandler.test.ts
└── services/
    ├── smartPatterns.test.ts
    └── smartSuggestions.test.ts
```

### 验收标准
- [ ] 所有 P0 模块测试通过
- [ ] 工具函数覆盖率 ≥ 95%
- [ ] 缓存层覆盖率 ≥ 90%
- [ ] 错误处理覆盖率 ≥ 90%
- [ ] 智能模式覆盖率 ≥ 95%

---

## Phase 3: P1 模块测试实现

### 目标
- 完成 Repository 层和 Service 层测试
- 达成目标覆盖率 80-85%

### 3.1 Repository 层测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 3.1.1 | `PrismaTransactionRepository` | `PrismaTransactionRepository.test.ts` | 25-30 | 85% |
| 3.1.2 | `PrismaBudgetRepository` | `PrismaBudgetRepository.test.ts` | 15-18 | 85% |
| 3.1.3 | `PrismaCategoryRepository` | `PrismaCategoryRepository.test.ts` | 12-15 | 85% |
| 3.1.4 | `PrismaCommonNoteRepository` | `PrismaCommonNoteRepository.test.ts` | 10-12 | 80% |
| 3.1.5 | `PrismaPaymentMethodRepository` | `PrismaPaymentMethodRepository.test.ts` | 10-12 | 80% |

#### PrismaTransactionRepository 测试用例明细

```
describe('findById')
  ✓ 根据 ID 查找交易
  ✓ 不存在返回 null
  ✓ 排除软删除记录

describe('findMany')
  ✓ 分页查询
  ✓ 类型筛选
  ✓ 分类筛选
  ✓ 日期范围筛选
  ✓ 金额范围筛选
  ✓ 排序选项

describe('create')
  ✓ 创建交易记录
  ✓ 默认货币为 CNY
  ✓ 可选字段处理

describe('update')
  ✓ 更新交易字段
  ✓ 部分更新

describe('softDelete')
  ✓ 设置 deleted_at

describe('getStats')
  ✓ 计算统计数据
  ✓ 应用筛选条件

describe('getStatsByCategory')
  ✓ 按分类分组
  ✓ 计算百分比
```

### 3.2 Service 层测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 3.2.1 | `TransactionQueryService` | `TransactionQueryService.test.ts` | 18-22 | 80% |
| 3.2.2 | `TransactionSummaryService` | `TransactionSummaryService.test.ts` | 15-18 | 80% |
| 3.2.3 | `TransactionAnalyticsService` | `TransactionAnalyticsService.test.ts` | 15-18 | 75% |
| 3.2.4 | `budgetService` | `budgetService.test.ts` | 20-25 | 80% |
| 3.2.5 | `categoryService` | `categoryService.test.ts` | 10-12 | 80% |

### 交付物
```
__tests__/unit/
├── repositories/
│   ├── PrismaTransactionRepository.test.ts
│   ├── PrismaBudgetRepository.test.ts
│   ├── PrismaCategoryRepository.test.ts
│   ├── PrismaCommonNoteRepository.test.ts
│   └── PrismaPaymentMethodRepository.test.ts
└── services/
    └── transaction/
        ├── TransactionQueryService.test.ts
        ├── TransactionSummaryService.test.ts
        └── TransactionAnalyticsService.test.ts
    ├── budgetService.test.ts
    └── categoryService.test.ts
```

### 验收标准
- [ ] Repository 层覆盖率 ≥ 85%
- [ ] Service 层覆盖率 ≥ 80%
- [ ] 所有测试通过

---

## Phase 4: P2 模块测试实现

### 目标
- 完成 API 路由和 AI 服务测试
- 达成目标覆盖率 70-75%

### 4.1 API 路由测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 4.1.1 | `/api/transactions` | `transactions.test.ts` | 15-18 | 75% |
| 4.1.2 | `/api/budgets` | `budgets.test.ts` | 12-15 | 75% |
| 4.1.3 | `/api/categories` | `categories.test.ts` | 10-12 | 75% |
| 4.1.4 | `/api/payment-methods` | `paymentMethods.test.ts` | 8-10 | 70% |

### 4.2 AI 服务测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 4.2.1 | `aiPrediction.server` | `aiPrediction.test.ts` | 18-22 | 70% |
| 4.2.2 | `AIFeedbackService` | `AIFeedbackService.test.ts` | 10-12 | 70% |

### 4.3 核心层测试

| 序号 | 模块 | 测试文件 | 预计用例数 | 目标覆盖率 |
|-----|------|---------|-----------|-----------|
| 4.3.1 | `EnhancedDataSync` | `EnhancedDataSync.test.ts` | 15-18 | 65% |
| 4.3.2 | `SyncStateManager` | `SyncStateManager.test.ts` | 10-12 | 65% |

### 交付物
```
__tests__/
├── unit/
│   ├── services/
│   │   ├── ai/
│   │   │   ├── aiPrediction.test.ts
│   │   │   └── AIFeedbackService.test.ts
│   │   └── ...
│   └── core/
│       ├── EnhancedDataSync.test.ts
│       └── SyncStateManager.test.ts
└── integration/
    └── api/
        ├── transactions.test.ts
        ├── budgets.test.ts
        ├── categories.test.ts
        └── paymentMethods.test.ts
```

### 验收标准
- [ ] API 路由覆盖率 ≥ 75%
- [ ] AI 服务覆盖率 ≥ 70%
- [ ] 核心层覆盖率 ≥ 65%
- [ ] 整体项目覆盖率 ≥ 80%

---

## 实施顺序建议

```
Phase 1 ────────────────────────────────────────────────────────►
         安装依赖 → 配置 Vitest → Setup → Mocks → Factories

Phase 2 ────────────────────────────────────────────────────────►
         date.ts → format.ts → validation.ts → MemoryCache →
         CacheDecorator → AppError → smartPatterns

Phase 3 ────────────────────────────────────────────────────────►
         TransactionRepository → BudgetRepository →
         TransactionQueryService → TransactionSummaryService →
         budgetService

Phase 4 ────────────────────────────────────────────────────────►
         API transactions → API budgets → aiPrediction →
         EnhancedDataSync
```

---

## 执行命令速查

```bash
# 运行所有测试
npm run test

# 监视模式
npm run test:watch

# 运行特定文件
npm run test -- date.test.ts

# 运行特定目录
npm run test -- __tests__/unit/utils

# 生成覆盖率报告
npm run test:coverage

# 可视化 UI
npm run test:ui

# 仅运行一次（CI 环境）
npm run test:run
```

---

## 下一步行动

确认方案后，将按以下顺序执行：

1. **Phase 1**: 安装依赖、创建配置文件
2. **Phase 2**: 逐个实现 P0 模块测试
3. **Phase 3**: 实现 Repository 和 Service 层测试
4. **Phase 4**: 完成 API 和 AI 服务测试

每个 Phase 完成后会提交代码并报告进度。
