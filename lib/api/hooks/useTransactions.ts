'use client';

/**
 * 交易相关 React Query Hooks
 */

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { queryKeys } from '../queryClient';
import {
  transactionsApi,
  type TransactionListParams,
  type CreateTransactionParams,
  type UpdateTransactionParams,
} from '../services/transactions';
import { enhancedDataSync, markTransactionsDirty } from '@/lib/core/EnhancedDataSync';

/**
 * 获取交易列表
 */
export function useTransactions(params?: TransactionListParams) {
  return useQuery({
    queryKey: queryKeys.transactions.list(params),
    queryFn: () => transactionsApi.list(params),
  });
}

/**
 * 获取单个交易
 */
export function useTransaction(id: string) {
  return useQuery({
    queryKey: queryKeys.transactions.detail(id),
    queryFn: () => transactionsApi.get(id),
    enabled: !!id,
  });
}

/**
 * 获取今日自动生成的交易
 */
export function useTodayAutoGeneratedTransactions() {
  return useQuery({
    queryKey: queryKeys.transactions.todayAutoGenerated(),
    queryFn: () => transactionsApi.getTodayAutoGenerated(),
  });
}

/**
 * 创建交易
 */
export function useCreateTransaction() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateTransactionParams) => transactionsApi.create(data),
    onSuccess: (newTransaction) => {
      // 使所有交易列表缓存失效
      queryClient.invalidateQueries({ queryKey: queryKeys.transactions.all });

      // 触发跨标签页同步
      enhancedDataSync.notifyTransactionAdded(newTransaction);
      markTransactionsDirty();
    },
  });
}

/**
 * 更新交易
 */
export function useUpdateTransaction() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: UpdateTransactionParams) => transactionsApi.update(data),
    onSuccess: (updatedTransaction, variables) => {
      // 更新单个交易的缓存
      queryClient.setQueryData(
        queryKeys.transactions.detail(variables.id),
        updatedTransaction
      );

      // 使列表缓存失效
      queryClient.invalidateQueries({ queryKey: queryKeys.transactions.all });

      // 触发跨标签页同步
      enhancedDataSync.notifyTransactionUpdated(updatedTransaction);
      markTransactionsDirty();
    },
  });
}

/**
 * 删除交易
 */
export function useDeleteTransaction() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: string) => transactionsApi.delete(id),
    onSuccess: (_, id) => {
      // 移除单个交易的缓存
      queryClient.removeQueries({ queryKey: queryKeys.transactions.detail(id) });

      // 使列表缓存失效
      queryClient.invalidateQueries({ queryKey: queryKeys.transactions.all });

      // 触发跨标签页同步
      enhancedDataSync.notifyTransactionDeleted({ id });
      markTransactionsDirty();
    },
  });
}

/**
 * 恢复已删除的交易
 */
export function useRestoreTransaction() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: string) => transactionsApi.restore(id),
    onSuccess: () => {
      // 使所有交易列表缓存失效
      queryClient.invalidateQueries({ queryKey: queryKeys.transactions.all });

      // 触发跨标签页同步
      enhancedDataSync.notifyTransactionAdded();
      markTransactionsDirty();
    },
  });
}
