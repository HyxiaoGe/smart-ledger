# Smart Ledger 优化行动计划

> 创建时间：2025-11-15
> 目标：提升代码质量、可维护性和可扩展性

## 📋 优化优先级

### 阶段一：模块化服务层重构 ⭐⭐⭐⭐⭐
**目标**：建立清晰的代码组织和职责分离，为后续优化打好基础

**预期收益**：
- 提升代码可维护性和可读性
- 降低模块间耦合度
- 便于团队协作和新人上手
- 为长期迭代打好基础

**关键任务**：
1. 建立清晰的分层架构（Client → Service → Domain）
2. 重构服务层，确保单一职责原则
3. 统一基础设施（缓存、错误处理、日志）
4. 整理和集中管理类型定义
5. 优化依赖关系和接口设计

### 阶段二：多策略智能推荐优化 ⭐⭐⭐⭐⭐
**目标**：优化核心功能，提升用户体验和智能化水平

**预期收益**：
- 提高推荐准确率和相关性
- 提升用户记账效率
- 增强产品竞争力
- 积累AI优化经验

**关键任务**：
1. 优化4种推荐算法（上下文/模式/频率/相似性）
2. 改进置信度计算模型
3. 增强学习系统的反馈闭环
4. 优化推荐结果的多样性和新颖性
5. 添加A/B测试和效果评估机制

### 阶段三：跨页面数据同步增强 ⭐⭐⭐⭐
**目标**：提升多标签页场景下的用户体验

**预期收益**：
- 保证数据一致性
- 避免用户困惑
- 提升专业度

**关键任务**：
1. 优化同步机制的性能
2. 增加同步状态反馈
3. 处理边界情况和异常
4. 添加冲突检测和解决

### 阶段四：统一任务队列扩展 ⭐⭐⭐
**目标**：增强并发控制能力

**关键任务**：
1. 增加优先级队列
2. 添加任务重试机制
3. 支持任务取消和超时
4. 添加任务监控和日志

### 阶段五：脏数据标记机制优化 ⭐⭐
**目标**：进一步优化性能

**关键任务**：
1. 评估实际性能收益
2. 简化标记逻辑
3. 与缓存系统统一集成

---

## 🎯 当前聚焦：阶段一 - 模块化服务层重构

### 现状分析

#### 当前架构问题
1. **职责不清晰**
   - `transactions.ts` 混合了查询、汇总、AI分析等多种职责
   - AI服务分散在5个文件中（`aiPrediction`, `aiFeedbackService`, `aiCacheService`, `aiCacheServiceServer`, `aiFeedbackServiceDB`）
   - 缓存逻辑分散在3个文件中（`cacheManager`, `predictionCache`, `unifiedCache`）

2. **依赖关系复杂**
   - 服务层直接依赖 Supabase 客户端
   - 缺少清晰的分层抽象
   - 模块间耦合度高

3. **代码重复**
   - 多个服务实现自己的单例模式
   - 多个服务实现自己的缓存逻辑
   - 错误处理方式不统一

4. **类型定义分散**
   - 类型既在 `types/` 目录，也在服务文件中内联
   - 缺少统一的类型管理

#### 目标架构

```
lib/
├── clients/              # 外部客户端层
│   ├── ai/              # AI服务客户端
│   └── supabase/        # 数据库客户端
├── domain/              # 领域逻辑层
│   ├── models/          # 领域模型
│   ├── repositories/    # 仓储接口
│   └── services/        # 领域服务
├── services/            # 应用服务层
│   ├── ai/             # AI相关服务（统一）
│   ├── transaction/    # 交易相关服务
│   ├── budget/         # 预算相关服务
│   ├── suggestion/     # 建议相关服务
│   └── cache/          # 缓存服务（统一）
├── infrastructure/      # 基础设施层
│   ├── cache/          # 缓存抽象
│   ├── errors/         # 错误处理
│   ├── logger/         # 日志
│   └── events/         # 事件总线
├── core/               # 核心工具
└── utils/              # 通用工具
```

### 优化方案

#### 1. 分层重构
- **Client 层**：负责外部系统交互（Supabase、AI API）
- **Repository 层**：数据访问抽象，隔离数据源
- **Service 层**：业务逻辑编排
- **Domain 层**：核心领域模型和规则

#### 2. 服务拆分原则
- **单一职责**：每个服务只负责一个业务领域
- **接口隔离**：定义清晰的服务接口
- **依赖倒置**：通过接口依赖，而非具体实现

#### 3. 统一基础设施
- **缓存抽象**：统一缓存接口，支持多种实现
- **错误处理**：统一错误类型和处理流程
- **日志系统**：结构化日志记录

#### 4. 类型系统整理
- **集中定义**：所有类型在 `types/` 目录
- **分类组织**：按领域划分类型文件
- **接口优先**：优先使用接口而非类型别名

### 具体重构任务

#### Task 1: 建立仓储层 ✅
- [x] 创建 `lib/domain/repositories/` 目录
- [x] 定义 `ITransactionRepository` 接口
- [x] 实现 `SupabaseTransactionRepository`
- [x] 定义 `IBudgetRepository` 接口
- [x] 定义 `ICommonNoteRepository` 接口
- [x] 实现 `SupabaseBudgetRepository`
- [x] 实现 `SupabaseCommonNoteRepository`
- [x] 创建 Repository 工厂和单例模式

**完成时间**: 2025-11-15
**文件**:
- `lib/domain/repositories/ITransactionRepository.ts`
- `lib/domain/repositories/IBudgetRepository.ts`
- `lib/domain/repositories/ICommonNoteRepository.ts`
- `lib/infrastructure/repositories/SupabaseTransactionRepository.ts`
- `lib/infrastructure/repositories/SupabaseBudgetRepository.ts`
- `lib/infrastructure/repositories/SupabaseCommonNoteRepository.ts`
- `lib/infrastructure/repositories/index.ts`

#### Task 2: 重构 Transaction 服务 ✅
- [x] 拆分 `transactions.ts` 为：
  - `TransactionQueryService` - 查询服务
  - `TransactionSummaryService` - 汇总服务
  - `TransactionAnalyticsService` - 分析数据服务
- [x] 移除直接的 Supabase 依赖
- [x] 通过 Repository 访问数据
- [x] 集成统一缓存系统
- [x] 创建服务工厂和单例模式

**完成时间**: 2025-11-15
**文件**:
- `lib/services/transaction/TransactionQueryService.ts`
- `lib/services/transaction/TransactionSummaryService.ts`
- `lib/services/transaction/TransactionAnalyticsService.ts`
- `lib/services/transaction/index.ts`

#### Task 3: 统一 AI 服务 ✅
- [x] 合并 AI 相关服务到 `lib/services/ai/` 目录
- [x] 创建 `AIPredictionService` - 预测服务
- [x] 创建 `AIAnalysisService` - 分析服务
- [x] 创建 `AIFeedbackService` - 反馈服务
- [x] 创建 `AICacheService` - AI缓存服务
- [x] 创建兼容层保持向后兼容

**完成时间**: 2025-11-16
**文件**:
- `lib/services/ai/AIPredictionService.ts`
- `lib/services/ai/AIAnalysisService.ts`
- `lib/services/ai/AIFeedbackService.ts`
- `lib/services/ai/AICacheService.ts`
- `lib/services/ai/index.ts`
- 兼容层: `aiPrediction.ts`, `aiFeedbackService.ts`, `aiCacheService.ts`

#### Task 4: 统一缓存系统 ✅
- [x] 定义 `ICache` 接口
- [x] 实现 `MemoryCache`
- [x] 实现 `LocalStorageCache`
- [x] 创建 `CacheDecorator` 装饰器
- [x] 支持 TTL、标签失效、前缀失效
- [x] 添加缓存统计和命中率追踪
- [x] 创建缓存工厂

**完成时间**: 2025-11-15
**文件**:
- `lib/infrastructure/cache/ICache.ts`
- `lib/infrastructure/cache/MemoryCache.ts`
- `lib/infrastructure/cache/LocalStorageCache.ts`
- `lib/infrastructure/cache/CacheDecorator.ts`
- `lib/infrastructure/cache/index.ts`

#### Task 5: 统一错误处理 ✅
- [x] 定义领域错误类型（30+ ErrorCode）
- [x] 创建错误处理中间件（withErrorHandler）
- [x] 统一API错误响应格式
- [x] 添加 traceId 请求追踪
- [x] 实现 safeAsync/safeSync 容错工具
- [x] 自动 Zod 错误转换

**完成时间**: 2025-11-16
**文件**:
- `lib/domain/errors/ErrorCode.ts`
- `lib/domain/errors/AppError.ts`
- `lib/domain/errors/errorHandler.ts`
- `lib/domain/errors/index.ts`
- `lib/domain/errors/README.md`

#### Task 6: 整理类型定义 ✅
- [x] 移动所有类型到 `types/` 目录
- [x] 按领域分类组织（domain/, dto/）
- [x] 移除重复定义（CommonNote 等）
- [x] 提取 DTO 类型到独立文件
- [x] 创建统一导出入口

**完成时间**: 2025-11-16
**文件**:
- `types/domain/transaction.ts`（移动）
- `types/dto/transaction.dto.ts`（新建）
- `types/dto/common-note.dto.ts`（新建）
- `types/dto/budget.dto.ts`（新建）
- `types/index.ts`（统一导出）

---

## 📊 进度追踪

| 阶段 | 状态 | 开始日期 | 完成日期 | 完成情况 |
|------|------|----------|----------|----------|
| 阶段一：模块化服务层 | ✅ 已完成 | 2025-11-15 | 2025-11-16 | 所有6个任务已完成 |
| 阶段二：智能推荐优化 | ⚪ 未开始 | 待定 | 待定 | - |
| 阶段三：数据同步增强 | ⚪ 未开始 | 待定 | 待定 | - |
| 阶段四：任务队列扩展 | ⚪ 未开始 | 待定 | 待定 | - |
| 阶段五：脏数据优化 | ⚪ 未开始 | 待定 | 待定 | - |

### 阶段一完成统计
- ✅ **Task 1**: Repository 层（3个接口 + 3个实现）
- ✅ **Task 2**: Transaction 服务重构（3个服务）
- ✅ **Task 3**: 统一 AI 服务（4个服务 + 兼容层）
- ✅ **Task 4**: 统一缓存系统（4个核心文件）
- ✅ **Task 5**: 统一错误处理（5个核心文件）
- ✅ **Task 6**: 整理类型定义（新增 DTO 层 + domain 重组）

**总计新增/重构**:
- 新增文件: 30+ 个
- 代码行数: 约 5000+ 行
- 关键 Commits:
  - `ce0a0b7` - Repository 层 + 缓存系统 + Transaction 服务
  - `266ee01` - 统一 AI 服务层架构
  - `7d72765` - 统一错误处理系统
  - `633643e` - 重构类型定义组织结构

---

## 📝 备注

- 每个阶段完成后需进行代码审查
- 重构时保持现有功能不变
- 添加单元测试覆盖
- 更新相关文档

---

## 🔗 相关资源

- [CLAUDE.md](./CLAUDE.md) - 项目开发指南
- [架构设计文档](待创建)
- [重构日志](待创建)
