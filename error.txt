PS E:\TypeScriptProject\smart-ledger> npx tsc --noEmit       
__tests__/__factories__/transaction.ts:26:5 - error TS2322: Type 'string | null' is not assignable to type 'string | undefined'.
  Type 'null' is not assignable to type 'string | undefined'.

26     payment_method: faker.helpers.arrayElement([...PAYMENT_METHODS, null]),
       ~~~~~~~~~~~~~~

  types/domain/transaction.ts:16:3
    16   payment_method?: string; // 支付方式 ID，关联到 payment_methods 表
         ~~~~~~~~~~~~~~
    The expected type comes from property 'payment_method' which is declared here on type 'Transaction'

__tests__/__factories__/transaction.ts:27:5 - error TS2322: Type 'string | null' is not assignable to type 'string | undefined'.
  Type 'null' is not assignable to type 'string | undefined'.

27     merchant: faker.helpers.maybe(() => faker.company.name(), { probability: 0.5 }) ?? null,
       ~~~~~~~~

  types/domain/transaction.ts:18:3
    18   merchant?: string; // 商家/品牌名称（如：瑞幸咖啡、地铁、美团）
         ~~~~~~~~
    The expected type comes from property 'merchant' which is declared here on type 'Transaction'

__tests__/__factories__/transaction.ts:28:5 - error TS2322: Type 'null' is not assignable to type 'string | undefined'.

28     subcategory: null,
       ~~~~~~~~~~~

  types/domain/transaction.ts:19:3
    19   subcategory?: string; // 子分类（如：coffee、subway、takeout）
         ~~~~~~~~~~~
    The expected type comes from property 'subcategory' which is declared here on type 'Transaction'

__tests__/__factories__/transaction.ts:29:5 - error TS2322: Type 'null' is not assignable to type 'string | undefined'.

29     product: null,
       ~~~~~~~

  types/domain/transaction.ts:20:3
    20   product?: string; // 具体产品/服务（如：生椰拿铁、地铁票、午餐外卖）
         ~~~~~~~
    The expected type comes from property 'product' which is declared here on type 'Transaction'

__tests__/unit/errors/errorHandler.test.ts:62:11 - error TS2353: Object literal may only specify known properties, and 'received' does not exist in type '$ZodIssueInvalidType<unknown>'.

62           received: 'number',
             ~~~~~~~~

__tests__/unit/errors/errorHandler.test.ts:83:11 - error TS2353: Object literal may only specify known properties, and 'received' does not exist in type '$ZodIssueInvalidType<unknown>'.

83           received: 'number',
             ~~~~~~~~

__tests__/unit/errors/errorHandler.test.ts:99:11 - error TS2353: Object literal may only specify known properties, and 'received' does not exist in type '$ZodIssueInvalidType<unknown>'.

99           received: 'number',
             ~~~~~~~~

__tests__/unit/errors/errorHandler.test.ts:115:11 - error TS2353: Object literal may only specify known properties, and 'received' does not exist in type '$ZodIssueInvalidType<unknown>'.

115           received: 'number',
              ~~~~~~~~

__tests__/unit/errors/errorHandler.test.ts:122:11 - error TS2353: Object literal may only specify known properties, and 'type' does not exist in type '$ZodIssueTooSmall<unknown>'.

122           type: 'string',
              ~~~~

__tests__/unit/errors/errorHandler.test.ts:182:11 - error TS2353: Object literal may only specify known properties, and 'received' does not exist in type '$ZodIssueInvalidType<unknown>'.

182           received: 'number',
              ~~~~~~~~

__tests__/unit/services/categoryService.test.ts:87:3 - error TS2741: Property 'getAllSubcategoriesBatch' is missing in type '{ findAll: Mock<Procedure>; findAllWithStats: Mock<Procedure>; findById: Mock<Procedure>; findByKey: Mock<Procedure>; ... 8 more ...; updateSortOrder: Mock<...>; }' but required in type 'ICategoryRepository'.

87   return {
     ~~~~~~

  lib/domain/repositories/ICategoryRepository.ts:83:3
    83   getAllSubcategoriesBatch(): Promise<Record<string, Subcategory[]>>;
         ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    'getAllSubcategoriesBatch' is declared here.

__tests__/unit/services/categoryService.test.ts:116:5 - error TS2353: Object literal may only specify known properties, and 'parent_id' does not exist in type 'Category'.

116     parent_id: null,
        ~~~~~~~~~

__tests__/unit/services/categoryService.test.ts:138:11 - error TS2353: Object literal may only specify known properties, and 'transactionCount' does not exist in type 'CategoryWithStats'.

138           transactionCount: 100,
              ~~~~~~~~~~~~~~~~

__tests__/unit/services/categoryService.test.ts:259:58 - error TS2345: Argument of type '{ deleted: boolean; migratedTransactions: number; }' is not assignable to parameter of type 'DeleteCategoryResult'.
  Type '{ deleted: boolean; migratedTransactions: number; }' is missing the following properties from type 'DeleteCategoryResult': success, message, affected_transactions

259       vi.mocked(mockRepository.delete).mockResolvedValue(deleteResult);
                                                             ~~~~~~~~~~~~

__tests__/unit/services/categoryService.test.ts:272:58 - error TS2345: Argument of type '{ deleted: boolean; migratedTransactions: number; }' is not assignable to parameter of type 'DeleteCategoryResult'.
  Type '{ deleted: boolean; migratedTransactions: number; }' is missing the following properties from type 'DeleteCategoryResult': success, message, affected_transactions

272       vi.mocked(mockRepository.delete).mockResolvedValue(deleteResult);
                                                             ~~~~~~~~~~~~

__tests__/unit/services/categoryService.test.ts:292:66 - error TS2345: Argument of type '{ category: Category; transactionCount: number; totalAmount: number; monthlyBreakdown: { month: string; count: number; amount: number; }[]; }' is not assignable to parameter of 
type 'CategoryUsageDetail'.
  Type '{ category: Category; transactionCount: number; totalAmount: number; monthlyBreakdown: { month: string; count: number; amount: number; }[]; }' is missing the following properties from type 'CategoryUsageDetail': total_transactions, total_amount, avg_amount, 
first_used, and 3 more.

292       vi.mocked(mockRepository.getUsageDetail).mockResolvedValue(usageDetail);
                                                                     ~~~~~~~~~~~

__tests__/unit/services/categoryService.test.ts:304:11 - error TS2353: Object literal may only specify known properties, and 'id' does not exist in type 'Subcategory'.

304         { id: 'sub-1', name: '午餐', count: 30 },
              ~~

__tests__/unit/services/categoryService.test.ts:305:11 - error TS2353: Object literal may only specify known properties, and 'id' does not exist in type 'Subcategory'.

305         { id: 'sub-2', name: '晚餐', count: 25 },
              ~~

__tests__/unit/services/categoryService.test.ts:322:42 - error TS2353: Object literal may only specify known properties, and 'id' does not exist in type 'Subcategory'.

322       const foodSubs: Subcategory[] = [{ id: 'sub-1', name: '午餐', count: 30 }];
                                             ~~

__tests__/unit/services/categoryService.test.ts:323:47 - error TS2353: Object literal may only specify known properties, and 'id' does not exist in type 'Subcategory'.

323       const transportSubs: Subcategory[] = [{ id: 'sub-2', name: '地铁', count: 20 }];
                                                  ~~

__tests__/unit/services/categoryService.test.ts:340:24 - error TS2353: Object literal may only specify known properties, and 'count' does not exist in type 'MerchantSuggestion'.

340         { name: '肯德基', count: 15, avgAmount: 35 },
                           ~~~~~

__tests__/unit/services/categoryService.test.ts:341:24 - error TS2353: Object literal may only specify known properties, and 'count' does not exist in type 'MerchantSuggestion'.

341         { name: '麦当劳', count: 10, avgAmount: 30 },
                           ~~~~~

__tests__/unit/services/smartSuggestions.test.ts:93:27 - error TS2345: Argument of type '{ suggestions: { id: string; content: string; confidence: number; }[]; fallback_notes: never[]; context: {}; }' is not assignable to parameter of type 'SmartSuggestionResponse'.  Types of property 'suggestions' are incompatible.
    Type '{ id: string; content: string; confidence: number; }[]' is not assignable to type 'SmartSuggestion[]'.
      Type '{ id: string; content: string; confidence: number; }' is missing the following properties from type 'SmartSuggestion': type, reason, source

93         cache.set(params, data);
                             ~~~~

__tests__/unit/services/smartSuggestions.test.ts:177:7 - error TS2322: Type '"smart"' is not assignable to type '"frequency" | "context" | "pattern" | "similarity"'.

177       type: 'smart',
          ~~~~

  types/domain/transaction.ts:45:3
    45   type: 'frequency' | 'context' | 'pattern' | 'similarity';
         ~~~~
    The expected type comes from property 'type' which is declared here on type 'SmartSuggestion'

__tests__/unit/services/smartSuggestions.test.ts:189:7 - error TS2561: Object literal may only specify known properties, but 'last_used_at' does not exist in type 'CommonNote'. Did you mean to write 'last_used'?

189       last_used_at: new Date().toISOString(),
          ~~~~~~~~~~~~

__tests__/unit/services/transaction/TransactionAnalyticsService.test.ts:43:5 - error TS2353: Object literal may only specify known properties, and 'updated_at' does not exist in type 'Transaction'.

43     updated_at: new Date().toISOString(),
       ~~~~~~~~~~

__tests__/unit/services/transaction/TransactionQueryService.test.ts:43:5 - error TS2353: Object literal may only specify known properties, and 'updated_at' does not exist in type 'Transaction'.

43     updated_at: new Date().toISOString(),
       ~~~~~~~~~~

__tests__/unit/services/transaction/TransactionSummaryService.test.ts:43:5 - error TS2353: Object literal may only specify known properties, and 'updated_at' does not exist in type 'Transaction'.

43     updated_at: new Date().toISOString(),
       ~~~~~~~~~~

__tests__/unit/services/transaction/TransactionSummaryService.test.ts:255:60 - error TS2345: Argument of type '{ totalAmount: number; count: number; averageAmount: number; maxAmount: number; minAmount: number; }' is not assignable to parameter of type 'TransactionStats'.
  Property 'avgAmount' is missing in type '{ totalAmount: number; count: number; averageAmount: number; maxAmount: number; minAmount: number; }' but required in type 'TransactionStats'.

255       vi.mocked(mockRepository.getStats).mockResolvedValue(mockStats);
                                                               ~~~~~~~~~

  types/dto/transaction.dto.ts:75:3
    75   avgAmount: number;
         ~~~~~~~~~
    'avgAmount' is declared here.

__tests__/unit/services/transaction/TransactionSummaryService.test.ts:266:9 - error TS2561: Object literal may only specify known properties, but 'averageAmount' does not exist in type 'TransactionStats'. Did you mean to write 'avgAmount'?

266         averageAmount: 0,
            ~~~~~~~~~~~~~

__tests__/unit/services/transaction/TransactionSummaryService.test.ts:284:9 - error TS2561: Object literal may only specify known properties, but 'averageAmount' does not exist in type 'TransactionStats'. Did you mean to write 'avgAmount'?

284         averageAmount: 0,
            ~~~~~~~~~~~~~

__tests__/unit/services/transaction/TransactionSummaryService.test.ts:302:9 - error TS2561: Object literal may only specify known properties, but 'averageAmount' does not exist in type 'TransactionStats'. Did you mean to write 'avgAmount'?

302         averageAmount: 0,
            ~~~~~~~~~~~~~

lib/infrastructure/repositories/prisma/PrismaTransactionRepository.ts:230:7 - error TS2769: No overload matches this call.
  Overload 1 of 3, '(callbackfn: (previousValue: PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }, currentValue: PickEnumerable<...> & { ...; }, currentIndex: number, array: (PickEnumerable<...> & { ...; })[]) => PickEnumerable<...> & { ...; }, initialValue: PickEnumerable<...> & { ...; }): PickEnumerable<...> & { ...; }', gave the following error.
    Argument of type '(sum: number, item: GroupResult) => number' is not assignable to parameter of type '(previousValue: PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }, currentValue: PickEnumerable<...> & { ...; }, currentIndex: number, array: (PickEnumerable<...> & { ...; })[]) => PickEnumerable<...> & { ...; }'.
      Types of parameters 'sum' and 'previousValue' are incompatible.
        Type 'PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }' is not assignable to type 'number'.
  Overload 2 of 3, '(callbackfn: (previousValue: number, currentValue: PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }, currentIndex: number, array: (PickEnumerable<...> & { ...; })[]) => number, initialValue: number): number', gave the following error.
    Argument of type '(sum: number, item: GroupResult) => number' is not assignable to parameter of type '(previousValue: number, currentValue: PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }, currentIndex: number, array: (PickEnumerable<...> & { ...; })[]) => number'.
      Types of parameters 'item' and 'currentValue' are incompatible.
        Type 'PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }' is not assignable to type 'GroupResult'.
          The types of '_sum.amount' are incompatible between these types.
            Type 'Decimal | null' is not assignable to type 'number | null'.
              Type 'Decimal' is not assignable to type 'number'.

230       (sum: number, item: GroupResult) => sum + (Number(item._sum.amount) || 0),
          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


lib/infrastructure/repositories/prisma/PrismaTransactionRepository.ts:235:12 - error TS2345: Argument of type '(item: GroupResult) => { category: string; totalAmount: number; count: number; percentage: number; }' is not assignable to parameter of type '(value: PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }, index: number, array: (PickEnumerable<...> & { ...; })[]) => { ...; }'.
  Types of parameters 'item' and 'value' are incompatible.
    Type 'PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }' is not assignable to type 'GroupResult'.
      The types of '_sum.amount' are incompatible between these types.
        Type 'Decimal | null' is not assignable to type 'number | null'.
          Type 'Decimal' is not assignable to type 'number'.

235       .map((item: GroupResult) => ({
               ~~~~~~~~~~~~~~~~~~~~~~~~~
236         category: item.category,
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
...
241           : 0,
    ~~~~~~~~~~~~~~
242       }))
    ~~~~~~~~

lib/infrastructure/repositories/prisma/PrismaTransactionRepository.ts:239:21 - error TS2365: Operator '>' cannot be applied to types 'PickEnumerable<TransactionsGroupByOutputType, "category"[]> & { _count: number; _sum: { amount: Decimal | null; }; }' and 'number'. 

239         percentage: totalAmount > 0
                        ~~~~~~~~~~~~~~~

lib/infrastructure/repositories/prisma/PrismaTransactionRepository.ts:240:48 - error TS2363: The right-hand side of an arithmetic operation must be of type 'any', 'number', 'bigint' or an enum type.

240           ? ((Number(item._sum.amount) || 0) / totalAmount) * 100
                                                   ~~~~~~~~~~~

lib/services/recurringService.server.ts:250:10 - error TS2345: Argument of type '(log: LogRow) => string | null' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => string | null'.
  Types of parameters 'log' and 'value' are incompatible.
    Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is missing the following properties from type 'LogRow': error_message, retry_count

250     .map((log: LogRow) => log.recurring_expense_id)
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

lib/services/recurringService.server.ts:253:10 - error TS2345: Argument of type '(log: LogRow) => string | null' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => string | null'.
  Types of parameters 'log' and 'value' are incompatible.
    Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is missing the following properties from type 'LogRow': error_message, retry_count

253     .map((log: LogRow) => log.generated_transaction_id)
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

lib/services/recurringService.server.ts:279:19 - error TS2345: Argument of type '(log: LogRow) => { id: string; recurring_expense_id: string | null; generation_date: string; generated_transaction_id: string | null; status: string; reason: string | null; created_at: 
string; recurring_expense: { ...; } | null; transaction: { ...; } | null; }' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => { ...; }'.
  Types of parameters 'log' and 'value' are incompatible.
    Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is missing the following properties from type 'LogRow': error_message, retry_count

279   return logs.map((log: LogRow) => {
                      ~~~~~~~~~~~~~~~~~~

lib/services/recurringService.server.ts:328:36 - error TS2769: No overload matches this call.
  Overload 1 of 2, '(predicate: (value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => 
value is { ...; }, thisArg?: any): { ...; }[]', gave the following error.
    Argument of type '(d: { status: string; }) => boolean' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => value is { ...; }'.
      Types of parameters 'd' and 'value' are incompatible.
        Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is not assignable to type '{ status: string; }'.
          Types of property 'status' are incompatible.
            Type 'string | null' is not assignable to type 'string'.
              Type 'null' is not assignable to type 'string'.
  Overload 2 of 2, '(predicate: (value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => 
unknown, thisArg?: any): { ...; }[]', gave the following error.
    Argument of type '(d: { status: string; }) => boolean' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => unknown'.
      Types of parameters 'd' and 'value' are incompatible.
        Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is not assignable to type '{ status: string; }'.
          Types of property 'status' are incompatible.
            Type 'string | null' is not assignable to type 'string'.
              Type 'null' is not assignable to type 'string'.

328   const successCount = logs.filter((d: { status: string }) => d.status === 'success').length;
                                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


lib/services/recurringService.server.ts:329:35 - error TS2769: No overload matches this call.
  Overload 1 of 2, '(predicate: (value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => 
value is { ...; }, thisArg?: any): { ...; }[]', gave the following error.
    Argument of type '(d: { status: string; }) => boolean' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => value is { ...; }'.
      Types of parameters 'd' and 'value' are incompatible.
        Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is not assignable to type '{ status: string; }'.
          Types of property 'status' are incompatible.
            Type 'string | null' is not assignable to type 'string'.
              Type 'null' is not assignable to type 'string'.
  Overload 2 of 2, '(predicate: (value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => 
unknown, thisArg?: any): { ...; }[]', gave the following error.
    Argument of type '(d: { status: string; }) => boolean' is not assignable to parameter of type '(value: { created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }, index: number, array: { ...; }[]) => unknown'.
      Types of parameters 'd' and 'value' are incompatible.
        Type '{ created_at: Date | null; id: string; recurring_expense_id: string | null; reason: string | null; generation_date: Date; generated_transaction_id: string | null; status: string | null; }' is not assignable to type '{ status: string; }'.
          Types of property 'status' are incompatible.
            Type 'string | null' is not assignable to type 'string'.
              Type 'null' is not assignable to type 'string'.

329   const failedCount = logs.filter((d: { status: string }) => d.status === 'failed').length;
                                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~



Found 41 errors in 9 files.

Errors  Files
     4  __tests__/__factories__/transaction.ts:26
     6  __tests__/unit/errors/errorHandler.test.ts:62
    12  __tests__/unit/services/categoryService.test.ts:87
     3  __tests__/unit/services/smartSuggestions.test.ts:93
     1  __tests__/unit/services/transaction/TransactionAnalyticsService.test.ts:43
     1  __tests__/unit/services/transaction/TransactionQueryService.test.ts:43
     5  __tests__/unit/services/transaction/TransactionSummaryService.test.ts:43
     4  lib/infrastructure/repositories/prisma/PrismaTransactionRepository.ts:230
     5  lib/services/recurringService.server.ts:250
PS E:\TypeScriptProject\smart-ledger> 