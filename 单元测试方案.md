# Smart Ledger 单元测试方案

## 1. 概述

本文档为 Smart Ledger 项目制定全面的单元测试策略。项目采用 Next.js 14 + Prisma + TypeScript 技术栈，使用 Repository 模式进行数据访问抽象，具备良好的可测试性基础。

### 1.1 测试框架选择

推荐使用 **Vitest** 作为测试框架，原因如下：
- 与 Vite 生态系统完美集成，支持 ESM
- 兼容 Jest API，迁移成本低
- 开箱即用的 TypeScript 支持
- 更快的执行速度和更好的 HMR 支持
- 内置代码覆盖率报告

### 1.2 辅助工具

| 工具 | 用途 |
|------|------|
| `@testing-library/react` | React 组件测试 |
| `vitest-mock-extended` | Mock 工具 |
| `msw` (Mock Service Worker) | API Mock |
| `@faker-js/faker` | 测试数据生成 |
| `prisma-mock` / 内存数据库 | 数据库 Mock |

---

## 2. 项目架构分析

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    App Layer (Next.js Pages/API)        │
├─────────────────────────────────────────────────────────┤
│                    Service Layer                         │
│   TransactionQueryService, TransactionSummaryService,   │
│   TransactionAnalyticsService, BudgetService, etc.      │
├─────────────────────────────────────────────────────────┤
│                    Repository Layer                      │
│   ITransactionRepository, IBudgetRepository, etc.       │
├─────────────────────────────────────────────────────────┤
│                    Infrastructure Layer                  │
│   PrismaTransactionRepository, MemoryCache, etc.        │
├─────────────────────────────────────────────────────────┤
│                    Domain Layer                          │
│   AppError, ErrorCode, Transaction, Budget, etc.        │
└─────────────────────────────────────────────────────────┘
```

### 2.2 可测试性分析

| 层级 | 可测试性 | 说明 |
|------|----------|------|
| 工具函数 (`lib/utils/*`) | ⭐⭐⭐⭐⭐ | 纯函数，无副作用，最易测试 |
| 缓存层 (`lib/infrastructure/cache/*`) | ⭐⭐⭐⭐⭐ | 独立模块，易于隔离测试 |
| 错误处理 (`lib/domain/errors/*`) | ⭐⭐⭐⭐⭐ | 纯逻辑，无外部依赖 |
| 智能模式 (`lib/services/smartPatterns.ts`) | ⭐⭐⭐⭐⭐ | 纯函数，基于模式匹配 |
| Repository 层 | ⭐⭐⭐⭐ | 需要 Mock Prisma Client |
| Service 层 | ⭐⭐⭐ | 需要 Mock Repository |
| API 路由 | ⭐⭐⭐ | 需要 Mock 请求/响应 |
| 核心层 (DataSync) | ⭐⭐ | 涉及浏览器 API |

---

## 3. 测试模块划分

### 3.1 优先级 P0：核心工具函数

**目标覆盖率：95%+**

#### 3.1.1 日期工具 (`lib/utils/date.ts`)

```typescript
// 测试用例示例
describe('date utilities', () => {
  describe('monthRange', () => {
    it('should return correct month range for given date', () => {});
    it('should handle year boundary correctly', () => {});
    it('should default to current date when no argument', () => {});
  });

  describe('parseMonthStr', () => {
    it('should parse valid YYYY-MM string', () => {});
    it('should return null for invalid format', () => {});
    it('should return null for invalid month values', () => {});
  });

  describe('formatMonth', () => {
    it('should format date to YYYY-MM string', () => {});
    it('should pad single digit months with zero', () => {});
  });

  describe('shiftMonth', () => {
    it('should shift month forward correctly', () => {});
    it('should shift month backward correctly', () => {});
    it('should handle year boundary', () => {});
  });

  describe('todayISO', () => {
    it('should return today in YYYY-MM-DD format', () => {});
    it('should use local timezone', () => {});
  });

  describe('formatDateToLocal', () => {
    it('should format date to YYYY-MM-DD using local timezone', () => {});
  });

  describe('dayRange', () => {
    it('should return start and end of day', () => {});
  });

  describe('yesterdayRange', () => {
    it('should return yesterday date range', () => {});
  });

  describe('lastNDaysRange', () => {
    it('should return correct range for last N days', () => {});
    it('should handle month boundaries', () => {});
  });

  describe('getQuickRange', () => {
    it('should return today range', () => {});
    it('should return yesterday range', () => {});
    it('should return last 7 days range', () => {});
    it('should return month range', () => {});
  });
});
```

#### 3.1.2 格式化工具 (`lib/utils/format.ts`)

```typescript
describe('format utilities', () => {
  describe('currencySymbol', () => {
    it('should return ¥ for CNY', () => {});
    it('should return $ for USD', () => {});
    it('should return empty string for unknown currency', () => {});
  });

  describe('formatAmount', () => {
    it('should format number with locale', () => {});
    it('should handle NaN', () => {});
    it('should limit decimal places to 2', () => {});
  });

  describe('formatCurrency', () => {
    it('should combine symbol and formatted amount', () => {});
  });
});
```

#### 3.1.3 验证工具 (`lib/utils/validation.ts`)

```typescript
describe('validation utilities', () => {
  describe('validateRequest', () => {
    it('should return success for valid data', () => {});
    it('should return formatted errors for invalid data', () => {});
    it('should handle ZodError correctly', () => {});
  });

  describe('commonSchemas', () => {
    describe('uuid', () => {
      it('should validate correct UUID format', () => {});
      it('should reject invalid UUID', () => {});
    });

    describe('date', () => {
      it('should validate YYYY-MM-DD format', () => {});
      it('should reject invalid date format', () => {});
    });

    describe('amount', () => {
      it('should validate positive numbers', () => {});
      it('should reject zero and negative numbers', () => {});
    });

    describe('currency', () => {
      it('should accept CNY and USD', () => {});
      it('should reject other currencies', () => {});
    });

    describe('transactionType', () => {
      it('should accept income and expense', () => {});
      it('should reject other types', () => {});
    });

    describe('month', () => {
      it('should validate YYYY-MM format', () => {});
    });
  });
});
```

### 3.2 优先级 P0：缓存层

**目标覆盖率：90%+**

#### 3.2.1 内存缓存 (`lib/infrastructure/cache/MemoryCache.ts`)

```typescript
describe('MemoryCache', () => {
  describe('get/set', () => {
    it('should store and retrieve values', () => {});
    it('should return null for non-existent keys', () => {});
  });

  describe('TTL', () => {
    it('should expire entries after TTL', () => {});
    it('should return null for expired entries', () => {});
  });

  describe('tags', () => {
    it('should associate entries with tags', () => {});
    it('should invalidate entries by tag', () => {});
  });

  describe('has', () => {
    it('should return true for existing keys', () => {});
    it('should return false for non-existent keys', () => {});
    it('should return false for expired keys', () => {});
  });

  describe('delete', () => {
    it('should remove entry from cache', () => {});
    it('should update tag index', () => {});
  });

  describe('clear', () => {
    it('should remove all entries', () => {});
    it('should reset stats', () => {});
  });

  describe('invalidateByPrefix', () => {
    it('should remove entries matching prefix', () => {});
  });

  describe('getStats', () => {
    it('should return hit/miss statistics', () => {});
    it('should calculate hit rate correctly', () => {});
  });

  describe('cleanup', () => {
    it('should remove expired entries', () => {});
  });
});
```

#### 3.2.2 缓存装饰器 (`lib/infrastructure/cache/CacheDecorator.ts`)

```typescript
describe('CacheDecorator', () => {
  describe('wrap', () => {
    it('should return cached value on hit', () => {});
    it('should execute function on miss', () => {});
    it('should store result in cache', () => {});
    it('should bypass cache when disabled', () => {});
  });

  describe('wrapSync', () => {
    it('should work with sync functions', () => {});
  });

  describe('invalidate', () => {
    it('should remove specific key', () => {});
  });

  describe('invalidateByTag', () => {
    it('should remove entries by tag', () => {});
  });

  describe('invalidateByPrefix', () => {
    it('should remove entries by prefix', () => {});
  });

  describe('withCache helper', () => {
    it('should provide convenient async caching', () => {});
  });

  describe('withCacheSync helper', () => {
    it('should provide convenient sync caching', () => {});
  });
});
```

### 3.3 优先级 P0：错误处理

**目标覆盖率：90%+**

#### 3.3.1 AppError (`lib/domain/errors/AppError.ts`)

```typescript
describe('AppError', () => {
  describe('constructor', () => {
    it('should set code, message, and statusCode', () => {});
    it('should use default message when not provided', () => {});
    it('should set metadata with timestamp', () => {});
    it('should default isOperational to true', () => {});
  });

  describe('toJSON', () => {
    it('should return structured error response', () => {});
    it('should include traceId when available', () => {});
    it('should include details when available', () => {});
  });

  describe('toDetailedJSON', () => {
    it('should include stack trace', () => {});
    it('should include full metadata', () => {});
  });
});

describe('Error factory classes', () => {
  describe('ValidationError', () => {
    it('should create validation error with correct code', () => {});
  });

  describe('NotFoundError', () => {
    it('should create not found error with resource info', () => {});
  });

  describe('DatabaseError', () => {
    it('should mark as non-operational', () => {});
  });

  describe('AIServiceError', () => {
    it('should use AI_SERVICE_ERROR code by default', () => {});
  });

  describe('InsufficientDataError', () => {
    it('should create insufficient data error', () => {});
  });

  describe('BusinessRuleError', () => {
    it('should create business rule error', () => {});
  });
});

describe('isAppError', () => {
  it('should return true for AppError instances', () => {});
  it('should return false for regular errors', () => {});
});

describe('isOperationalError', () => {
  it('should return true for operational AppErrors', () => {});
  it('should return false for non-operational errors', () => {});
});
```

### 3.4 优先级 P0：智能模式识别

**目标覆盖率：95%+**

#### 3.4.1 消费模式 (`lib/services/smartPatterns.ts`)

```typescript
describe('smartPatterns', () => {
  describe('CONSUMPTION_PATTERNS', () => {
    it('should contain valid pattern definitions', () => {});
    it('should have valid amount ranges', () => {});
    it('should have confidence values between 0 and 1', () => {});
  });

  describe('matchConsumptionPattern', () => {
    it('should match drink category with correct amount', () => {});
    it('should match transport category with correct amount', () => {});
    it('should match food category with correct amount', () => {});
    it('should return null for no match', () => {});
    it('should return null for amount out of range', () => {});
  });

  describe('getPatternBasedSuggestions', () => {
    it('should return suggestions for matching pattern', () => {});
    it('should prioritize exact price point matches', () => {});
    it('should return empty array for no match', () => {});
    it('should include confidence and reason', () => {});
  });

  describe('getConsumptionStats', () => {
    it('should return high frequency for high confidence patterns', () => {});
    it('should return medium frequency for medium confidence', () => {});
    it('should return low frequency for unmatched patterns', () => {});
  });
});
```

### 3.5 优先级 P1：Repository 层

**目标覆盖率：85%+**

#### 3.5.1 Repository Mock 策略

```typescript
// __mocks__/prisma.ts
import { PrismaClient } from '@prisma/client';
import { mockDeep, DeepMockProxy } from 'vitest-mock-extended';

export const prismaMock = mockDeep<PrismaClient>();

// 或使用内存数据库
import { PrismaClient } from '@prisma/client';

export async function createTestPrismaClient() {
  const prisma = new PrismaClient({
    datasources: {
      db: { url: 'file:./test.db' }
    }
  });
  await prisma.$connect();
  return prisma;
}
```

#### 3.5.2 PrismaTransactionRepository

```typescript
describe('PrismaTransactionRepository', () => {
  describe('findById', () => {
    it('should find transaction by id', () => {});
    it('should return null for non-existent id', () => {});
    it('should exclude soft-deleted transactions', () => {});
  });

  describe('findMany', () => {
    it('should return paginated results', () => {});
    it('should apply type filter', () => {});
    it('should apply category filter', () => {});
    it('should apply date range filter', () => {});
    it('should apply amount range filter', () => {});
    it('should apply currency filter', () => {});
    it('should apply sort options', () => {});
  });

  describe('findByDateRange', () => {
    it('should find transactions in date range', () => {});
    it('should filter by type when provided', () => {});
  });

  describe('findByMonth', () => {
    it('should find transactions for specific month', () => {});
    it('should handle year boundary', () => {});
  });

  describe('create', () => {
    it('should create new transaction', () => {});
    it('should set default currency to CNY', () => {});
    it('should handle optional fields', () => {});
  });

  describe('update', () => {
    it('should update transaction fields', () => {});
    it('should only update provided fields', () => {});
  });

  describe('softDelete', () => {
    it('should set deleted_at timestamp', () => {});
  });

  describe('hardDelete', () => {
    it('should permanently delete transaction', () => {});
  });

  describe('restore', () => {
    it('should clear deleted_at timestamp', () => {});
  });

  describe('getStats', () => {
    it('should calculate correct statistics', () => {});
    it('should apply filter to stats', () => {});
  });

  describe('getStatsByCategory', () => {
    it('should group transactions by category', () => {});
    it('should calculate percentages correctly', () => {});
    it('should sort by total amount descending', () => {});
  });

  describe('createMany', () => {
    it('should create multiple transactions', () => {});
    it('should use transaction for atomicity', () => {});
  });

  describe('exists', () => {
    it('should return true for existing transaction', () => {});
    it('should return false for non-existent transaction', () => {});
    it('should return false for soft-deleted transaction', () => {});
  });

  describe('findRecent', () => {
    it('should return most recent transactions', () => {});
    it('should respect limit parameter', () => {});
    it('should filter by type when provided', () => {});
  });
});
```

### 3.6 优先级 P1：Service 层

**目标覆盖率：80%+**

#### 3.6.1 TransactionQueryService

```typescript
describe('TransactionQueryService', () => {
  let service: TransactionQueryService;
  let mockRepository: DeepMockProxy<ITransactionRepository>;
  let mockCache: ICache;

  beforeEach(() => {
    mockRepository = mock<ITransactionRepository>();
    mockCache = new MemoryCache();
    service = new TransactionQueryService(mockRepository, mockCache);
  });

  describe('listByRange', () => {
    it('should return cached results on cache hit', () => {});
    it('should query repository on cache miss', () => {});
    it('should handle month range', () => {});
    it('should handle today range', () => {});
    it('should handle yesterday range', () => {});
    it('should handle last7 range', () => {});
    it('should handle custom date range', () => {});
  });

  describe('listYesterdayTransactions', () => {
    it('should return yesterday transactions', () => {});
    it('should return empty array for non-yesterday range', () => {});
  });

  describe('listRecent', () => {
    it('should return recent transactions', () => {});
    it('should respect limit parameter', () => {});
  });

  describe('findById', () => {
    it('should return transaction by id', () => {});
    it('should cache results', () => {});
  });

  describe('findByMonth', () => {
    it('should return transactions for month', () => {});
    it('should cache results', () => {});
  });

  describe('clearCache', () => {
    it('should invalidate transaction cache', () => {});
  });
});
```

#### 3.6.2 TransactionSummaryService

```typescript
describe('TransactionSummaryService', () => {
  describe('getCurrentMonthSummary', () => {
    it('should aggregate transactions by date', () => {});
    it('should calculate total amount and count', () => {});
    it('should cache results', () => {});
  });

  describe('getMonthSummary', () => {
    it('should return summary for specific month', () => {});
  });

  describe('getCategorySummary', () => {
    it('should group by category', () => {});
    it('should calculate percentages', () => {});
  });

  describe('getDateRangeSummary', () => {
    it('should summarize custom date range', () => {});
  });

  describe('getStats', () => {
    it('should return statistics for date range', () => {});
  });

  describe('aggregateByDate (private)', () => {
    it('should correctly aggregate transactions', () => {});
  });
});
```

#### 3.6.3 TransactionAnalyticsService

```typescript
describe('TransactionAnalyticsService', () => {
  describe('getAIAnalysisData', () => {
    it('should return current and last month data', () => {});
    it('should return top 20 transactions', () => {});
    it('should handle custom target month', () => {});
  });

  describe('getPredictionData', () => {
    it('should return monthly data for specified months', () => {});
    it('should calculate category analysis', () => {});
    it('should compute overall stats', () => {});
    it('should evaluate data quality', () => {});
  });

  describe('analyzeCategoryData (private)', () => {
    it('should group transactions by category', () => {});
    it('should calculate trends', () => {});
  });

  describe('analyzeSpendingPatterns (private)', () => {
    it('should calculate spending frequency', () => {});
    it('should calculate average amount', () => {});
  });

  describe('analyzeSeasonalPatterns (private)', () => {
    it('should detect seasonality level', () => {});
    it('should calculate monthly variation', () => {});
  });

  describe('analyzeTimeDistribution (private)', () => {
    it('should analyze day of week distribution', () => {});
    it('should determine time preference', () => {});
  });
});
```

### 3.7 优先级 P2：API 路由

**目标覆盖率：75%+**

```typescript
describe('Transaction API Routes', () => {
  describe('GET /api/transactions', () => {
    it('should return paginated transactions', () => {});
    it('should apply query filters', () => {});
    it('should validate query parameters', () => {});
    it('should handle errors gracefully', () => {});
  });

  describe('POST /api/transactions', () => {
    it('should create new transaction', () => {});
    it('should validate request body', () => {});
    it('should update common notes', () => {});
    it('should revalidate cache', () => {});
    it('should return 400 for invalid data', () => {});
  });
});
```

### 3.8 优先级 P2：AI 预测服务

**目标覆盖率：70%+**

```typescript
describe('AIPredictionServiceServer', () => {
  describe('predictTransaction', () => {
    it('should generate time-based predictions', () => {});
    it('should generate pattern-based predictions', () => {});
    it('should generate recent-based predictions', () => {});
    it('should cache results', () => {});
  });

  describe('predictCategory', () => {
    it('should predict based on amount patterns', () => {});
    it('should query historical data', () => {});
  });

  describe('predictAmount', () => {
    it('should predict based on category patterns', () => {});
    it('should use price points', () => {});
  });

  describe('generateQuickSuggestions', () => {
    it('should generate time-based suggestions', () => {});
    it('should generate pattern-based suggestions', () => {});
  });
});
```

---

## 4. 测试配置

### 4.1 Vitest 配置文件

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
    include: ['**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}'],
    exclude: ['node_modules', '.next', 'e2e'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/types/**',
        'coverage/**',
      ],
      thresholds: {
        global: {
          statements: 80,
          branches: 75,
          functions: 80,
          lines: 80,
        },
      },
    },
    alias: {
      '@': path.resolve(__dirname, './'),
    },
  },
});
```

### 4.2 Setup 文件

```typescript
// vitest.setup.ts
import { beforeAll, afterAll, afterEach, vi } from 'vitest';
import { cleanup } from '@testing-library/react';

// Mock Next.js 模块
vi.mock('next/cache', () => ({
  revalidateTag: vi.fn(),
  revalidatePath: vi.fn(),
}));

vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    back: vi.fn(),
  }),
  usePathname: () => '/',
  useSearchParams: () => new URLSearchParams(),
}));

// Mock localStorage
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
  length: 0,
  key: vi.fn(),
};
global.localStorage = localStorageMock as Storage;

// Cleanup after each test
afterEach(() => {
  cleanup();
  vi.clearAllMocks();
});
```

### 4.3 Package.json 脚本

```json
{
  "scripts": {
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:coverage": "vitest --coverage",
    "test:ui": "vitest --ui",
    "test:run": "vitest run"
  },
  "devDependencies": {
    "vitest": "^2.0.0",
    "@vitest/coverage-v8": "^2.0.0",
    "@vitest/ui": "^2.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.0.0",
    "vitest-mock-extended": "^2.0.0",
    "@faker-js/faker": "^8.0.0",
    "msw": "^2.0.0"
  }
}
```

---

## 5. 目录结构

建议的测试文件组织结构：

```
smart-ledger/
├── __tests__/                    # 测试根目录
│   ├── unit/                     # 单元测试
│   │   ├── utils/
│   │   │   ├── date.test.ts
│   │   │   ├── format.test.ts
│   │   │   ├── validation.test.ts
│   │   │   ├── helpers.test.ts
│   │   │   └── storage.test.ts
│   │   ├── cache/
│   │   │   ├── MemoryCache.test.ts
│   │   │   ├── LocalStorageCache.test.ts
│   │   │   └── CacheDecorator.test.ts
│   │   ├── errors/
│   │   │   ├── AppError.test.ts
│   │   │   └── errorHandler.test.ts
│   │   ├── services/
│   │   │   ├── smartPatterns.test.ts
│   │   │   ├── smartSuggestions.test.ts
│   │   │   ├── transaction/
│   │   │   │   ├── TransactionQueryService.test.ts
│   │   │   │   ├── TransactionSummaryService.test.ts
│   │   │   │   └── TransactionAnalyticsService.test.ts
│   │   │   ├── budgetService.test.ts
│   │   │   └── aiPrediction.test.ts
│   │   └── repositories/
│   │       ├── PrismaTransactionRepository.test.ts
│   │       ├── PrismaBudgetRepository.test.ts
│   │       └── PrismaCategoryRepository.test.ts
│   ├── integration/              # 集成测试
│   │   └── api/
│   │       ├── transactions.test.ts
│   │       ├── budgets.test.ts
│   │       └── categories.test.ts
│   └── __mocks__/               # Mock 文件
│       ├── prisma.ts
│       └── next-cache.ts
├── vitest.config.ts
└── vitest.setup.ts
```

---

## 6. 测试数据工厂

### 6.1 交易数据工厂

```typescript
// __tests__/__factories__/transaction.ts
import { faker } from '@faker-js/faker';
import type { Transaction, CreateTransactionDTO } from '@/types';

export const createMockTransaction = (
  overrides?: Partial<Transaction>
): Transaction => ({
  id: faker.string.uuid(),
  type: 'expense',
  category: faker.helpers.arrayElement(['food', 'transport', 'drink', 'daily']),
  amount: faker.number.float({ min: 1, max: 1000, fractionDigits: 2 }),
  note: faker.lorem.words(3),
  date: faker.date.recent().toISOString().slice(0, 10),
  created_at: faker.date.recent().toISOString(),
  currency: 'CNY',
  payment_method: faker.helpers.arrayElement(['cash', 'wechat', 'alipay', null]),
  merchant: faker.company.name(),
  subcategory: null,
  product: null,
  ...overrides,
});

export const createMockTransactionDTO = (
  overrides?: Partial<CreateTransactionDTO>
): CreateTransactionDTO => ({
  type: 'expense',
  category: faker.helpers.arrayElement(['food', 'transport', 'drink', 'daily']),
  amount: faker.number.float({ min: 1, max: 1000, fractionDigits: 2 }),
  note: faker.lorem.words(3),
  date: faker.date.recent().toISOString().slice(0, 10),
  currency: 'CNY',
  ...overrides,
});

export const createMockTransactions = (
  count: number,
  overrides?: Partial<Transaction>
): Transaction[] =>
  Array.from({ length: count }, () => createMockTransaction(overrides));
```

---

## 7. 实施计划

### 第一阶段：基础设施搭建（1-2天）

1. 安装 Vitest 及相关依赖
2. 配置 vitest.config.ts
3. 创建 vitest.setup.ts
4. 设置 Mock 文件结构
5. 创建测试数据工厂

### 第二阶段：P0 模块测试（3-5天）

1. 工具函数测试
   - `lib/utils/date.ts`
   - `lib/utils/format.ts`
   - `lib/utils/validation.ts`
2. 缓存层测试
   - `MemoryCache`
   - `CacheDecorator`
3. 错误处理测试
   - `AppError` 及其子类
4. 智能模式测试
   - `smartPatterns.ts`

### 第三阶段：P1 模块测试（5-7天）

1. Repository 层测试
   - `PrismaTransactionRepository`
   - `PrismaBudgetRepository`
   - 其他 Repository
2. Service 层测试
   - `TransactionQueryService`
   - `TransactionSummaryService`
   - `TransactionAnalyticsService`
   - `BudgetService`

### 第四阶段：P2 模块测试（3-5天）

1. API 路由测试
2. AI 预测服务测试
3. 数据同步服务测试

### 第五阶段：持续集成（1-2天）

1. 配置 GitHub Actions
2. 设置覆盖率报告
3. 配置 pre-commit hooks

---

## 8. 覆盖率目标

| 模块类别 | 目标覆盖率 | 说明 |
|---------|-----------|------|
| 工具函数 | 95%+ | 核心逻辑，必须高覆盖 |
| 缓存层 | 90%+ | 关键基础设施 |
| 错误处理 | 90%+ | 异常流程保障 |
| 智能模式 | 95%+ | 业务核心逻辑 |
| Repository 层 | 85%+ | 数据访问层 |
| Service 层 | 80%+ | 业务逻辑层 |
| API 路由 | 75%+ | 接口层 |
| AI 服务 | 70%+ | 复杂逻辑 |
| **整体目标** | **80%+** | |

---

## 9. 最佳实践

### 9.1 测试命名规范

```typescript
// 使用 describe 嵌套组织测试
describe('ModuleName', () => {
  describe('methodName', () => {
    it('should [expected behavior] when [condition]', () => {});
  });
});

// 示例
describe('MemoryCache', () => {
  describe('get', () => {
    it('should return cached value when key exists', () => {});
    it('should return null when key does not exist', () => {});
    it('should return null when entry has expired', () => {});
  });
});
```

### 9.2 AAA 模式

```typescript
it('should calculate total correctly', () => {
  // Arrange - 准备测试数据
  const transactions = [
    createMockTransaction({ amount: 100 }),
    createMockTransaction({ amount: 200 }),
  ];

  // Act - 执行被测代码
  const total = calculateTotal(transactions);

  // Assert - 验证结果
  expect(total).toBe(300);
});
```

### 9.3 Mock 策略

```typescript
// 优先使用依赖注入而非全局 Mock
class TransactionService {
  constructor(private repository: ITransactionRepository) {}
}

// 测试时注入 Mock
const mockRepo = mock<ITransactionRepository>();
const service = new TransactionService(mockRepo);
```

### 9.4 避免测试实现细节

```typescript
// ❌ 不好：测试实现细节
it('should call prisma.transactions.findMany', () => {
  expect(prismaMock.transactions.findMany).toHaveBeenCalled();
});

// ✅ 好：测试行为
it('should return transactions matching filter', () => {
  const result = await repository.findMany({ type: 'expense' });
  expect(result.data).toHaveLength(5);
  expect(result.data.every(t => t.type === 'expense')).toBe(true);
});
```

---

## 10. 维护建议

1. **新功能必须包含测试**：PR 中新增功能必须有对应测试
2. **Bug 修复需添加回归测试**：修复 Bug 时添加相应测试用例
3. **定期审查覆盖率报告**：确保覆盖率不下降
4. **重构时优先保证测试通过**：使用测试保护重构
5. **保持测试快速执行**：单元测试应在几秒内完成

---

## 附录 A：依赖安装命令

```bash
# 安装核心测试依赖
npm install -D vitest @vitest/coverage-v8 @vitest/ui

# 安装 React 测试库
npm install -D @testing-library/react @testing-library/jest-dom

# 安装 Mock 工具
npm install -D vitest-mock-extended msw

# 安装测试数据生成
npm install -D @faker-js/faker
```

## 附录 B：CI 配置示例

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
```
